<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>jordanbrock.com &mdash; Vagrant + Chef (and OpenPhoto)</title>
    <link href="/css/reset.css" rel="stylesheet" type="text/css" />
    <link href="/css/screen.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/css/syntax.css" media="screen" rel="stylesheet" type="text/css" />
    <link rel="openid.server" href="http://openid.claimid.com/server">
    <link rel="openid.delegate" href="http://openid.claimid.com/jordanbrock">
    <script type="text/javascript" src="http://use.typekit.com/wmw7icf.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4f8d0d2df5a1f54576000010');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>

  </head>
  <body>
    <div id="container">
      <header>
      <h1><a href="/">Jordan Brock</a></h1>
      </header>
      <div id="content">
        <h2>Vagrant + Chef (and OpenPhoto)</h2>
<time class="meta" datetime="2012-04-17">
  Apr 17, 2012
</time>
<article class="post">
  <p>I&#8217;ve spent the past couple of days playing with <a href="http://www.vagrantup.com" target="_blank">VagrantÂ </a>, which is an add-on for <a href="http://www.virtualbox.org" target="_blank">VirtualBox</a> that allows you to quickly build virtual machines, configured exactly how you want them, on a project by project basis. The advantage of this is that it lets you replicate your production environment (or as close to as is possible), which should hopefully reduce headaches when you deploy your updates.</p>
<p>Vagrant VM&#8217;s are portable, which means that all of your team members can have exactly the same development environment, regardless of their own system setups. Once again: less headaches.</p>
<h3>Vagrant</h3>
<p>How does it work? Well, first of all, you need the <a href="https://www.virtualbox.org/wiki/Downloads">latest version of VirtualBox</a>, and the vagrant gem. I installed it into my system gems, but there&#8217;s no reason it couldn&#8217;t be in your Gemfile if you&#8217;re working on a ruby project.</p>
<div class="highlight"><pre><code class="bash">gem install vagrant
</code></pre>
</div>
<p>Once it&#8217;s all setup (read the <a href="http://vagrantup.com/docs/getting-started/index.html" target="_blank">full instructions</a> for some additional steps), you need to initialise your directory:</p>
<div class="highlight"><pre><code class="bash">vagrant init
</code></pre>
</div>
<p>This creates a file called &#8220;Vagrantfile&#8221; which configures your VM&#8217;s for each project. The most basic file would look like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Vagrant</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;lucid32&quot;</span>
<span class="k">end</span>
</code></pre>
</div>
<p>This tells vagrant to start up a VM using an Ubuntu image. It will boot the VM, and then set a port redirect up so that you can <span class="caps">SSH</span> into the VM with the following:</p>
<div class="highlight"><pre><code class="bash">vagrant ssh
</code></pre>
</div>
<p>That&#8217;s all very handy, but of course, you&#8217;re going to want your machine to have some software configured. Enter Chef, stage left.</p>
<h3>Chef</h3>
<p><a href="http://wiki.opscode.com/display/chef/Home" target="_blank">Chef</a> is a framework that lets you create &#8220;recipes&#8221; to install and configure software on VM&#8217;s. Basically, it&#8217;s a scripting system for getting a blank VM up and running.</p>
<p>As a good starting point, Opscode have a <a href="https://github.com/opscode/cookbooks/">great repository</a> of &#8220;cookbooks&#8221; (collections of recipes &#8211; natch) on github that you can fork and start using without having to make too many (if any) changes.</p>
<p>To work with Vagrant and Chef, you need a VM configured for Vagrant with a recent build of Ruby installed, as well as the chef. Setting up an Ubuntu 11.10 VM for Vagrant is relatively simple. Just follow steps 1-3 in <a href="http://www.yodi.me/blog/2011/10/26/build-base-box-vagrant-ubuntu-oneiric-11.10-server/">these instructions</a>.</p>
<p>Once that was complete, you need to install Ruby. Here&#8217;s a <a href="http://boris.muehmer.de/2012/03/18/ruby-1-9-3-p125-from-source-on-ubuntu-10-04-lts/">quick guide</a> to installing Ruby 1.9.3-125 from source on Ubuntu.</p>
<p>Then I installed the chef gem</p>
<div class="highlight"><pre><code class="bash">gem install chef
</code></pre>
</div>
<p>to get chef-client and chef-solo on the VM. <em>(Note: I&#8217;m only dealing with chef-solo in this post. chef-server adds a layer of difficulty that isn&#8217;t necessary at this stage.)</em></p>
<p>Once you have your base VM setup, you need to package it up for Vagrant, so it can load it up in VirtualBox as needed.</p>
<div class="highlight"><pre><code class="bash">mkdir ~/Vagrant <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/Vagrant

vagrant package --base vagrant-oneiric package.box

vagrant box add vagrant-oneiric package.box 
</code></pre>
</div>
<p>At this point, you should have a base VM ready for configuring with Chef.</p>
<h3>Vagrant and Chef, sitting in a tree</h3>
<p>Vagrant is built to work with provisioning software such as Chef (and <a href="http://puppetlabs.com/">puppet</a>). You add a series of Chef commands to your Vagrantfile that it will run on your VM as it is being configured.</p>
<p>To add recipes to your VM you just add the following to your Vagrantfile:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;mysql::server&quot;</span><span class="p">)</span>
</code></pre>
</div>
<p>Chef allows for configuration settings, such as passwords and installation directories, to be passed through to recipes. Vagrant supports this as well:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
  <span class="n">chef</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">:mysql</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:server_root_password</span> <span class="o">=&gt;</span> <span class="s2">&quot;secretpassword&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;mysql::server&quot;</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<h3>OpenPhoto</h3>
<p>OpenPhoto is an open source photo service that allows you to retain control of your photos, rather than store them with some site that may not even exist in 3 years. Your photos are stored on AmazonS3 or on Dropbox, and you can run a server yourself to maintain total control over the whole setup if you wish, or use their hosted service available here: <a href="http://openphoto.me">http://openphoto.me</a>.</p>
<p>Being open source, anyone can contribute to the system, and as with most open source projects, they need as much help as they can get. So, I&#8217;ve started tinkering with it, and I thought it was a good candidate to run with Vagrant and Chef to setup test servers quickly and painlessly.</p>
<p>So, if you want to do the same, here&#8217;s my Vagrantfile for my OpenPhoto directory, which is a git clone of my fork of the <a href="https://github.com/openphoto/frontend">OpenPhoto repository</a> on github. It should hopefully allow you to get up and running if you&#8217;ve done everything outlined above.</p>
<div class="highlight"><pre><code class="ruby"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;vagrant-oneiric&quot;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_solo</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">binary_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/chef/binary/&quot;</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">cookbooks_path</span> <span class="o">=</span> <span class="s2">&quot;/path/to/chef/cookbooks&quot;</span>

    <span class="n">chef</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:mysql</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="ss">:server_root_password</span> <span class="o">=&gt;</span> <span class="s2">&quot;secretpassword&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;mysql::server&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;imagemagick&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_curl&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_mysql&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_apc&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_dev&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_imagick&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_mcrypt&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;php::module_gd&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2::mod_rewrite&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2::mod_deflate&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2::mod_headers&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2::mod_expires&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;apache2::mod_php5&quot;</span><span class="p">)</span>
    <span class="n">chef</span><span class="o">.</span><span class="n">add_recipe</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span> <span class="s2">&quot;openphoto&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/openphoto&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/openphoto/frontend&quot;</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="s2">&quot;www-data&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s2">&quot;vagrant&quot;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">forward_port</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8080</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Run</p>
<div class="highlight"><pre><code class="bash">vagrant up
</code></pre>
</div>
<p>and that will build your new VM using the base image, and then configure all of the required software. It might take a little while :)</p>
<p>One of the great things about Vagrant is that you can quickly share folders with your VM, which means I can edit files in my repository on my Mac, which are shared onto the VM. This is accomplished with this line:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span> <span class="s2">&quot;openphoto&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/openphoto&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/openphoto/frontend&quot;</span><span class="p">,</span> <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="s2">&quot;www-data&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s2">&quot;vagrant&quot;</span>
</code></pre>
</div>
<h4>Apache</h4>
<p>You&#8217;ll also need to configure Apache to use this directory. Here&#8217;s my config file:</p>
<div class="highlight"><pre><code class="apache"><span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
  <span class="nb">DocumentRoot</span> <span class="sx">/var/www/openphoto/src/html</span>

  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/openphoto/src/html&quot;</span><span class="nt">&gt;</span>
    <span class="nb">Order</span> deny,allow
    <span class="nb">Allow</span> from <span class="k">all</span>

    <span class="nb">RewriteEngine</span> <span class="k">on</span>
    <span class="nb">RewriteCond</span> %{REQUEST_FILENAME} !-f
    <span class="nb">RewriteCond</span> %{REQUEST_FILENAME} !-d
    <span class="nb">RewriteRule</span> ^(.*)\?*$ index.php?__route__=/$1 [L,QSA]

    <span class="c"># 403 Forbidden for ini files</span>
    <span class="nb">RewriteRule</span> \.ini$ - [F,NC]

    <span class="nb">AddOutputFilterByType</span> DEFLATE text/plain
    <span class="nb">AddOutputFilterByType</span> DEFLATE text/html
    <span class="nb">AddOutputFilterByType</span> DEFLATE text/css
    <span class="nb">AddOutputFilterByType</span> DEFLATE application/x-javascript
    <span class="nb">BrowserMatch</span> ^Mozilla/4 gzip-only-text/html
    <span class="nb">BrowserMatch</span> ^Mozilla/4\.0[678] no-gzip
    <span class="nb">BrowserMatch</span> \bMSIE !no-gzip !gzip-only-text/html 
  <span class="nt">&lt;/Directory&gt;</span>

  <span class="c"># 404 Not Found for ini files</span>
  <span class="c">#AliasMatch \.ini$    /404</span>

  <span class="nb">ExpiresActive</span> <span class="k">On</span>
  <span class="nb">ExpiresByType</span> text/javascript <span class="s2">&quot;A31536000&quot;</span>
  <span class="nb">ExpiresByType</span> application/x-javascript <span class="s2">&quot;A31536000&quot;</span>
  <span class="nb">ExpiresByType</span> text/css <span class="s2">&quot;A31536000&quot;</span>
  <span class="nb">ExpiresByType</span> image/x-icon <span class="s2">&quot;A31536000&quot;</span>
  <span class="nb">ExpiresByType</span> image/gif <span class="s2">&quot;A604800&quot;</span>
  <span class="nb">ExpiresByType</span> image/jpg <span class="s2">&quot;A604800&quot;</span>
  <span class="nb">ExpiresByType</span> image/jpeg <span class="s2">&quot;A604800&quot;</span>
  <span class="nb">ExpiresByType</span> image/png <span class="s2">&quot;A604800&quot;</span>
  
  <span class="nb">Header</span> set Cache-Control <span class="s2">&quot;must-revalidate&quot;</span>
  <span class="nb">FileETag</span> MTime Size
<span class="nt">&lt;/VirtualHost&gt;</span>
</code></pre>
</div>
<p>You can then add a port forwarding rule to provide easy access to the Apache server running on the VM, like so:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">forward_port</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">8080</span>
</code></pre>
</div>
<p>Then, fire up &#8220;http://localhost:8080&#8221; in your browser, and you should be looking at your OpenPhoto install!</p>
</article>

      </div>
      <div id="sidebar">
        <h2>Stuff</h2>
        <ul>
          <li><a href="/archive.html">Archive</a></li>
          <li><a href="http://photos.jordanbrock.com">OpenPhoto</a></li>
          <li><a href="http://twitter.com/jordanbrock">twitter</a></li>
          <li><a href="http://strava.com/athletes/jordanbrock">Strava</a></li>
        </ul>
      </div>
      <footer>
        By me.
      </footer>
    </div>
  </body>
</html>
